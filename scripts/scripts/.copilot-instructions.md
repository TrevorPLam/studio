# Scripts Directory Instructions

**Path:** `/scripts`
**Purpose:** Build scripts, tools, and utilities
**Agent Role:** Primary (GitHub Copilot)

---

## Quick Reference

### Before making changes, read
- [BESTPR.md](../BESTPR.md) - Token-optimized best practices guide
- [Constitution](../docs/governance/constitution.md) - Core laws and governance

---

## Directory Structure

```text
scripts/
├── tools/                    # Development tools
│   ├── compile-constitution.mjs
│   ├── check-exceptions.mjs
│   ├── check-traceability.mjs
│   └── check-agent-platform.mjs
├── docs/                     # Documentation scripts
├── build.js                  # Build script
├── check-worklets-version.mjs
├── check-expo-config.mjs
├── post-install-check.mjs
├── deep-dependency-check.mjs
└── check-startup-blockers.mjs
```text

---

## Key Patterns

### 1. Constitutional Tools
```javascript
// scripts/tools/compile-constitution.mjs
// Generates .github/instructions/*.instructions.md from constitution.md
// Run: npm run compile:constitution

// scripts/tools/check-exceptions.mjs
// Verifies exception waivers have expiry dates
// Run: npm run check:exceptions

// scripts/tools/check-traceability.mjs
// Validates links between docs, code, tests
// Run: npm run check:traceability

// scripts/tools/check-agent-platform.mjs
// Ensures no Platform.OS checks in primary agent code
// Run: npm run check:agent-platform
```text

### 2. Script Conventions
```javascript
// ✅ DO: Use ES modules (.mjs)
import fs from 'fs'
import path from 'path'

// ✅ DO: Exit with proper codes
process.exit(0)  // Success
process.exit(1)  // Failure

// ✅ DO: Provide helpful error messages
console.error('❌ Error: File not found at', filePath)

// ✅ DO: Use colors for output (if applicable)
console.log('✅ Success: All checks passed')
console.error('❌ Error: Validation failed')
console.warn('⚠️  Warning: Potential issue detected')
```text

### 3. File Operations
```javascript
// ✅ DO: Use absolute paths
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const rootDir = join(__dirname, '..')

// ✅ DO: Check file existence
if (!fs.existsSync(filePath)) {
  console.error('File not found:', filePath)
  process.exit(1)
}
```text

### 4. Configuration Checks
```javascript
// ✅ DO: Validate configurations
// Example: check-worklets-version.mjs
const worklets = dependencies['react-native-worklets']
if (worklets !== '0.5.1') {
  console.error('❌ Worklets must be 0.5.1')
  process.exit(1)
}
```text

---

## Critical Rules

1. **Constitutional Enforcement:** Scripts enforce constitutional laws
2. **Exit Codes:** 0 = success, 1 = failure
3. **Error Messages:** Clear, actionable, with file paths
4. **ES Modules:** Use .mjs extension
5. **Absolute Paths:** Never use relative paths
6. **Type Safety:** Use JSDoc or TypeScript where applicable

---

## Constitutional Tools Purpose

| Script | Purpose | Run Command |
| -------- | --------- | ------------- |
| `compile-constitution.mjs` | Generate instruction files from constitution | `npm run compile:constitution` |
| `check-exceptions.mjs` | Verify exception waivers | `npm run check:exceptions` |
| `check-traceability.mjs` | Validate documentation links | `npm run check:traceability` |
| `check-agent-platform.mjs` | Ensure no Platform.OS in primary code | `npm run check:agent-platform` |
| `check-worklets-version.mjs` | Verify Worklets version | `npm run check:worklets` |
| `check-expo-config.mjs` | Validate Expo configuration | `npm run check:expo-config` |
| `post-install-check.mjs` | Post-install validations | `npm run check:postinstall` |
| `deep-dependency-check.mjs` | Check dependency tree | `npm run check:deps` |
| `check-startup-blockers.mjs` | Identify startup issues | `npm run check:startup` |

---

## Adding New Scripts

### Checklist for New Scripts

- [ ] Use ES modules (.mjs extension)
- [ ] Use absolute paths (no relative paths)
- [ ] Exit with proper codes (0 = success, 1 = failure)
- [ ] Provide clear error messages
- [ ] Add to package.json scripts
- [ ] Document purpose in this file
- [ ] Test success and failure cases
- [ ] Add to CI if appropriate

### Template for New Script

```javascript
#!/usr/bin/env node
/**
* Script Purpose: [Description]
* Usage: npm run [script-name]
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const rootDir = path.join(__dirname, '..')

async function main() {
  try {
    // Script logic here
    console.log('✅ Success: Task completed')
    process.exit(0)
  } catch (error) {
    console.error('❌ Error:', error.message)
    process.exit(1)
  }
}

main()
```text

---

## Common Operations

### Read Package.json
```javascript
const packageJson = JSON.parse(
  fs.readFileSync(path.join(rootDir, 'package.json'), 'utf-8')
)
```text

### Read Constitution
```javascript
const constitution = fs.readFileSync(
  path.join(rootDir, 'docs/governance/constitution.md'),
  'utf-8'
)
```text

### Check File Existence
```javascript
if (!fs.existsSync(filePath)) {
  console.error('❌ File not found:', filePath)
  process.exit(1)
}
```text

### Validate JSON
```javascript
try {
  JSON.parse(content)
} catch (error) {
  console.error('❌ Invalid JSON:', filePath)
  process.exit(1)
}
```text

---

## Before Committing

- [ ] Read [BESTPR.md](../BESTPR.md)
- [ ] Script uses ES modules (.mjs)
- [ ] Absolute paths used
- [ ] Exit codes correct (0 = success, 1 = failure)
- [ ] Error messages clear and actionable
- [ ] Added to package.json scripts
- [ ] Tested success and failure cases
- [ ] Documentation updated
- [ ] No secrets in code

---

### See [BESTPR.md](../BESTPR.md) for comprehensive best practices