# ============================================================================
# SECURITY SCANNING WORKFLOW
# ============================================================================
#
# @file .github/workflows/security.yml
# @epic BP-DEP-008
#
# PURPOSE:
# Automated security scanning for dependency vulnerabilities and license compliance.
# Runs on every push and pull request to main branch.
#
# CHECKS:
# - npm audit: dependency vulnerability scanning
# - License compliance: checks for problematic licenses
# - Fails CI on critical/high severity vulnerabilities
#
# CONFIGURATION:
# - Set FAIL_ON_VULNERABILITIES environment variable to control behavior
# - Default: fails on critical/high severity vulnerabilities
#
# RELATED FILES:
# - package.json (audit scripts)
# - .github/dependabot.yml (automated dependency updates)
#
# @see TODO.md BP-DEP-008
#
# ============================================================================

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  # ============================================================================
  # JOB: DEPENDENCY VULNERABILITY SCANNING
  # ============================================================================
  audit:
    name: Dependency Vulnerability Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --json > audit-report.json || true
          
          # Check for critical/high vulnerabilities
          if npm audit --audit-level=high; then
            echo "✅ No critical or high severity vulnerabilities found"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          else
            echo "❌ Critical or high severity vulnerabilities found"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        run: |
          echo "❌ Build failed due to critical or high severity vulnerabilities"
          echo "Run 'npm audit fix' to attempt automatic fixes"
          echo "Or review vulnerabilities with 'npm audit'"
          exit 1

  # ============================================================================
  # JOB: LICENSE COMPLIANCE SCANNING
  # ============================================================================
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "Checking dependency licenses..."
          license-checker --onlyAllow "MIT;Apache-2.0;ISC;BSD-2-Clause;BSD-3-Clause;Apache-2.0;0BSD;Unlicense;CC0-1.0" \
            --excludePrivatePackages \
            --json > license-report.json || true
          
          # List all licenses found
          license-checker --summary

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

      - name: Warn on non-approved licenses
        run: |
          echo "⚠️  Review license-report.json for any non-approved licenses"
          echo "Approved licenses: MIT, Apache-2.0, ISC, BSD-2-Clause, BSD-3-Clause, 0BSD, Unlicense, CC0-1.0"
